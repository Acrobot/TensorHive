swagger: "2.0"

info:
  title: "{{title}} {{version}}"
  version: "{{version}}"

basePath: "/{{url_prefix}}"

paths:
  /users:
    get:
      tags: 
        - users
      summary: Get all users
      responses:
        '200':
          description: All fetched with success.
          schema:
            type: array
            items:
              $ref: '#/definitions/User'
      security:
          - Bearer: []
  /user/register:
    post:
      tags: 
        - users
      summary: Create new user
      operationId: 'tensorhive.api.controllers.user.post_register'
      parameters:
        - description: User object
          in: body
          name: user
          required: true
          schema:
            $ref: '#/definitions/CreateUserController'
      responses:
        '201':
          description: Successfully created.
        '409':
          description: Duplication error.
        '500':
          $ref: '#/responses/InternalError'
  /user/logout:
    delete:
      tags:
        - users
      summary: Logout user with access token
      operationId: 'tensorhive.api.controllers.user.post_logout_access_token'
      responses:
        '201':
          description: Successfully deleted.
        '500':
          $ref: '#/responses/InternalError'
      security:
          - Bearer: []
  /user/rtokenlogoutrash:
    delete:
      tags:
        - users
      summary: Logout user with refresh token
      operationId: 'tensorhive.api.controllers.user.post_logout_refresh_token'
      responses:
        '201':
          description: Successfully deleted.
        '500':
          $ref: '#/responses/InternalError'
      security:
          - Bearer: []
  /user/refresh:
    get:
      tags:
        - users
      summary: Refresh users token
      operationId: 'tensorhive.api.controllers.user.get_refreshed_access_token'
      responses:
        '201':
          description: Successfully refreshed.
        '500':
          $ref: '#/responses/InternalError'
      security:
          - Bearer: []
  /user/login:
    post:
      tags:
        - users
      summary: Login user
      operationId: 'tensorhive.api.controllers.user.post_login'
      parameters:
        - description: User object
          in: body
          name: user
          required: true
          schema:
            $ref: '#/definitions/UserLoginController'
      responses:
        '201':
          description: Successfully loged in.
        '401':
          description: Incorrect credentials.
        '404':
          description: User does not exist.
        '500':
          $ref: '#/responses/InternalError'
  /reservations:
    get:
      tags: 
        - reservations
      summary: Get all reservation events
      parameters:
        - description: Array of uuids
          in: query
          name: resources_ids
          required: false
          type: array
          items: {
              type: string
            }
        - description: UTC ISO (e.g. 2019-10-22T19:23:45Z)
          in: query
          name: start
          required: false
          type: string
          format: date-time
        - description: UTC ISO
          in: query
          name: end
          required: false
          type: string
          format: date-time
      responses:
        '200':
          description: All fetched with success.
          schema:
            type: array
            items:
              $ref: '#/definitions/ReservationEvent'
        '400':
          description: Bad request. You have to specifiy either all parameters or none
      security:
          - Bearer: []
    post:
      tags: 
        - reservations
      summary: Create new reservation event
      parameters:
        - description: Reservation event object
          in: body
          name: reservation_event
          required: true
          schema:
            $ref: '#/definitions/CreateReservationEventController'
      responses:
        '201':
          description: Successfully created.
        '400':
          $ref: '#/responses/BadRequest'
        '500':
          $ref: '#/responses/InternalError'
      security:
          - Bearer: []
  /reservations/{id}:
    delete:
      tags: 
          - reservations
      summary: Delete reservation event by id
      parameters:
        - description: Id of reservation event
          in: path
          name: id
          required: true
          type: integer
      responses:
        '204':
          description: Successfully deleted.
        '404':
          $ref: '#/responses/NotFound'
      security:
          - Bearer: []
  # TODO Nodes: Add more specific schemas, response codes + descriptions
  /nodes/hostnames:
    get:
      tags: 
        - nodes
      summary: Get all hostnames
      operationId: 'tensorhive.api.controllers.nodes.get_hostnames'
      responses:
        '200':
          description: List of hostnames fetched with success
          schema:
            type: array
            items: 
              type: string
      security:
          - Bearer: []
  /nodes/metrics:
    get:
      tags: 
        - nodes
      summary: Get each node's all metric data
      operationId: 'tensorhive.api.controllers.nodes.get_all_metrics'
      responses:
        '200':
          description: 'Success'
          schema:
            type: object
      security:
          - Bearer: []
  /nodes/{hostname}/gpu/info:
    get:
      tags: 
        - nodes
      summary: Get node's basic GPU information
      operationId: 'tensorhive.api.controllers.nodes.get_gpu_info'
      parameters:
        - $ref: '#/parameters/hostnameParam'
      responses:
        '200':
          description: 'Success'
          schema:
            type: array
            items: 
              type: object
        '404':
          $ref: '#/responses/NotFound'
      security:
          - Bearer: []
  /nodes/{hostname}/gpu/metrics:
    get:
      tags: 
        - nodes
      summary: Get node's GPU metric data
      operationId: 'tensorhive.api.controllers.nodes.get_gpu_metrics'
      parameters:
        - $ref: '#/parameters/hostnameParam'
        - $ref: '#/parameters/gpuMetricTypeQuery'
      responses:
        '200':
          description: 'Success'
          schema:
            type: array
            items: 
              type: object
        '404':
          $ref: '#/responses/NotFound'
      security:
          - Bearer: []
  /nodes/{hostname}/gpu/processes:
    get:
      tags: 
        - nodes
      summary: Get node's GPU processes data
      operationId: 'tensorhive.api.controllers.nodes.get_gpu_processes'
      parameters:
        - $ref: '#/parameters/hostnameParam'
      responses:
        '200':
          description: 'Success'
          schema:
            type: array
            items: 
              type: object
        '404':
          $ref: '#/responses/NotFound'
      security:
          - Bearer: []
definitions:
  CreateUserController:
    type: object
    properties:
      username: { type: string }
      password: { type: string }
  UserLoginController:
    type: object
    properties:
      username: { type: string }
      password: { type: string }
  User:
    type: object
    properties:
      id:
        type: integer
        format: int64
      username: { type: string }
      createdAt:
        type: string
        format: date-time
  CreateReservationEventController:
    type: object
    properties:
      title: { type: string }
      description: { type: string }
      resourceId: { type: string }
      userId: { type: integer }
      start:
        type: string
        format: date-time
      end:
        type: string
        format: date-time
  ReservationEvent:
    type: object
    properties:
      id:
        type: integer
        format: int64
      title: { type: string }
      description: { type: string }
      resourceId: { type: string }
      userId: { type: integer}
      start:
        type: string
        format: date-time
      end:
        type: string
        format: date-time
      createdAt:
        type: string
        format: date-time

responses:
  # Example responses
  # TODO Define more complex behaviour and use these reusable responses where possible (when API begins to stabilize)
  NotFound:
    description: Resource was not found
  Unauthorized:
    description: Unauthorized
  InternalError:
    description: Internal Server Error
  BadRequest:
    description: Bad Request

parameters:
  hostnameParam:
    description: Node's hostname in the network
    in: path
    name: hostname
    required: true
    type: string
  gpuMetricTypeQuery:
    description: Metric type. If not present, queries for all metrics
    in: query
    name: metric_type
    required: false
    type: string
    enum:
      - fan_speed
      - mem_free
      - mem_used
      - mem_total
      - gpu_util
      - mem_util
      - temp
      - power

securityDefinitions:
  Bearer:
    type: apiKey
    name: Authorization
    in: header